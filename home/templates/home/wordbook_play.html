{% extends 'home/base.html' %}
{% load static %}

{% block title %}ã‚¯ã‚¤ã‚ºãƒ—ãƒ¬ã‚¤ - {{ wordbook.title }}{% endblock %}

{% block content %}
<div class="container quiz-page">
    <div class="quiz-page-header">
        <div class="quiz-page-meta">
            <span class="quiz-wordbook-title">{{ wordbook.title }}</span>
            <span class="quiz-card-count">ã‚«ãƒ¼ãƒ‰: {{ card_count }}æš</span>
        </div>
    </div>

    <div id="quizNotice" class="quiz-section" style="display: none;"></div>

    <div id="quizPlay" class="quiz-section">
        <div class="quiz-header">
            <div class="quiz-timer">
                <svg viewBox="0 0 120 120">
                    <defs>
                        <linearGradient id="timerGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#FFB5C0;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#FF9AA8;stop-opacity:1" />
                        </linearGradient>
                    </defs>
                    <circle cx="60" cy="60" r="54" class="timer-bg"></circle>
                    <circle cx="60" cy="60" r="54" class="timer-progress" id="quizTimerProgress"></circle>
                </svg>
                <span id="quizTimerLabel" class="timer-label">15</span>
            </div>
            <div class="quiz-progress">
                <div class="quiz-count" id="quizCount">1/10</div>
            </div>
        </div>

        <div class="quiz-question" id="quizQuestion">question</div>

        <div class="quiz-options" id="quizOptions"></div>
    </div>

    <div id="quizFeedback" class="quiz-section" style="display: none;">
        <div class="quiz-feedback-container">
            <div class="quiz-feedback-icon" id="quizFeedbackIcon"></div>
            <h3 id="quizFeedbackTitle" class="quiz-feedback-title">æ­£è§£</h3>
            <p id="quizFeedbackAnswer" class="quiz-feedback-answer"></p>
            <div class="quiz-countdown" id="quizCountdown">3</div>
        </div>
    </div>

    <div id="quizResult" class="quiz-section" style="display: none;">
        <div class="quiz-result-container">
            <div class="quiz-emoji" id="quizEmoji">ğŸ˜„</div>
            <h2 class="quiz-result-heading">ãŠã¤ã‹ã‚Œã•ã¾ã§ã—ãŸï¼</h2>
            <div class="quiz-stats">
                <div class="quiz-stat-card correct">
                    <div class="stat-icon">âœ“</div>
                    <div class="stat-value" id="quizCorrectCount">0</div>
                    <div class="stat-label">æ­£è§£æ•°</div>
                </div>
                <div class="quiz-stat-card incorrect" id="incorrectCard" onclick="toggleMistakesList()" style="cursor: pointer;">
                    <div class="stat-icon">âœ—</div>
                    <div class="stat-value" id="quizIncorrectCount">0</div>
                    <div class="stat-label">é–“é•ãˆãŸå•é¡Œ</div>
                    <div class="stat-arrow" id="mistakesArrow">â–¼</div>
                </div>
            </div>
            <div id="quizMistList" class="quiz-miss-list" style="display: none;"></div>
            <div class="quiz-result-actions">
                <button type="button" class="btn btn-primary" onclick="restartPlay('all')">ã‚‚ã†ä¸€åº¦ãƒ—ãƒ¬ã‚¤</button>
                <button type="button" id="reviewReplayBtn" class="btn btn-secondary" onclick="restartPlay('review')">é–“é•ãˆãŸå•é¡Œã ã‘å¾©ç¿’</button>
                <a class="btn btn-outline" href="{% url 'wordbook_detail' wordbook.pk %}">å˜èªå¸³ã«æˆ»ã‚‹</a>
            </div>
        </div>
    </div>
</div>

<script>
const quizWordbookId = {{ wordbook.pk }};
const quizCards = JSON.parse("{{ cards_json|escapejs }}");
const urlParams = new URLSearchParams(window.location.search);
const modeParam = urlParams.get('mode') || 'all';
const difficultyParam = urlParams.get('difficulty') || '15';

const quizState = {
    questions: [],
    currentIndex: 0,
    correctCount: 0,
    mistakes: [],
    mode: modeParam,
    timeLimit: difficultyParam === 'unlimited' ? null : parseInt(difficultyParam, 10) || 15,
    timerId: null,
    countdownTimer: null
};

const noticeBox = document.getElementById('quizNotice');

function initQuiz() {
    const source = quizState.mode === 'review' ? loadStoredMistakes() : quizCards;
    const minRequired = quizState.mode === 'review' ? 1 : 4;
    if (source.length < minRequired) {
        showNotice(quizState.mode === 'review'
            ? 'é–“é•ãˆãŸå•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“ã€‚é€šå¸¸ãƒ—ãƒ¬ã‚¤ã§å•é¡Œã‚’è§£ã„ã¦ãã ã•ã„ã€‚'
            : 'ãƒ—ãƒ¬ã‚¤ã™ã‚‹ã«ã¯ã‚«ãƒ¼ãƒ‰ãŒ4æšä»¥ä¸Šå¿…è¦ã§ã™ã€‚');
        return;
    }
    quizState.questions = shuffleArray([...source]);
    quizState.currentIndex = 0;
    quizState.correctCount = 0;
    quizState.mistakes = [];
    setSection('quizPlay');
    renderQuizQuestion();
}

function showNotice(text) {
    noticeBox.style.display = 'block';
    noticeBox.innerHTML = `
        <div class="quiz-feedback-card" style="text-align:center;">
            <p class="quiz-feedback-answer">${text}</p>
            <div class="quiz-result-actions" style="justify-content:center;">
                <a class="btn btn-primary" href="{% url 'wordbook_detail' wordbook.pk %}">å˜èªå¸³ã«æˆ»ã‚‹</a>
                <a class="btn btn-secondary" href="{% url 'wordbook_play' wordbook.pk %}?mode=all">é€šå¸¸ãƒ—ãƒ¬ã‚¤ã«æˆ»ã‚‹</a>
            </div>
        </div>`;
    setSection('quizNotice');
}

function setSection(section) {
    ['quizNotice','quizPlay','quizFeedback','quizResult'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.style.display = (id === section) ? 'block' : 'none';
    });
}

function renderQuizQuestion() {
    const q = quizState.questions[quizState.currentIndex];
    const options = buildOptions(q);
    if (!options) {
        showNotice('é¸æŠè‚¢ã‚’ç”Ÿæˆã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ã‚«ãƒ¼ãƒ‰æ•°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
        return;
    }
    
    const questionEl = document.getElementById('quizQuestion');
    questionEl.textContent = q.front;
    
    // è³ªå•æ–‡ã®é•·ã•ã«å¿œã˜ã¦ã‚¯ãƒ©ã‚¹ã‚’è¨­å®š
    const questionLength = q.front.length;
    if (questionLength > 30) {
        questionEl.setAttribute('data-length', 'extra-long');
    } else if (questionLength > 20) {
        questionEl.setAttribute('data-length', 'long');
    } else if (questionLength > 12) {
        questionEl.setAttribute('data-length', 'medium');
    } else {
        questionEl.removeAttribute('data-length');
    }
    
    document.getElementById('quizCount').textContent = `${quizState.currentIndex + 1}/${quizState.questions.length}`;

    const optsContainer = document.getElementById('quizOptions');
    optsContainer.innerHTML = '';
    options.forEach((opt, index) => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = `quiz-option ${index % 2 === 0 ? 'pink' : 'green'}`;
        btn.textContent = opt.back;
        btn.onclick = () => handleQuizAnswer(opt, false);
        
        // ãƒœã‚¿ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®é•·ã•ã«å¿œã˜ã¦ã‚¯ãƒ©ã‚¹ã‚’è¨­å®š
        const optionLength = opt.back.length;
        if (optionLength > 30) {
            btn.setAttribute('data-length', 'extra-long');
        } else if (optionLength > 20) {
            btn.setAttribute('data-length', 'long');
        } else if (optionLength > 12) {
            btn.setAttribute('data-length', 'medium');
        }
        
        optsContainer.appendChild(btn);
    });

    startQuizTimer();
}

function handleQuizAnswer(selectedOption, timedOut) {
    stopQuizTimer();
    const current = quizState.questions[quizState.currentIndex];
    const isCorrect = !timedOut && selectedOption && selectedOption.id === current.id;

    if (isCorrect) {
        quizState.correctCount += 1;
        showQuizFeedback('æ­£è§£', '');
    } else {
        quizState.mistakes.push(current);
        const title = timedOut ? 'æ™‚é–“åˆ‡ã‚Œ' : 'ä¸æ­£è§£';
        showQuizFeedback(title, `æ­£ã—ã„ç­”ãˆ: ${current.back}`);
    }
}

function nextQuizQuestion() {
    if (quizState.countdownTimer) {
        clearInterval(quizState.countdownTimer);
    }
    quizState.currentIndex += 1;
    if (quizState.currentIndex >= quizState.questions.length) {
        showQuizResult();
    } else {
        setSection('quizPlay');
        renderQuizQuestion();
    }
}

function showQuizFeedback(title, answerText) {
    const isCorrect = title === 'æ­£è§£';
    const iconEl = document.getElementById('quizFeedbackIcon');
    iconEl.className = 'quiz-feedback-icon ' + (isCorrect ? 'correct' : 'incorrect');
    iconEl.innerHTML = isCorrect ? 'âœ“' : 'âœ—';
    
    document.getElementById('quizFeedbackTitle').textContent = title;
    document.getElementById('quizFeedbackAnswer').textContent = answerText;
    
    setSection('quizFeedback');
    startCountdown();
}

function startCountdown() {
    const countdownEl = document.getElementById('quizCountdown');
    let count = 3;
    countdownEl.textContent = count;
    
    if (quizState.countdownTimer) {
        clearInterval(quizState.countdownTimer);
    }
    
    quizState.countdownTimer = setInterval(() => {
        count--;
        if (count > 0) {
            countdownEl.textContent = count;
        } else {
            clearInterval(quizState.countdownTimer);
            nextQuizQuestion();
        }
    }, 1000);
}

function showQuizResult() {
    saveMistakes();
    const total = quizState.questions.length;
    const correct = quizState.correctCount;
    const incorrect = quizState.mistakes.length;
    const accuracy = correct / total;
    
    // é¡”æ–‡å­—ã‚’è¨­å®š
    const emojiEl = document.getElementById('quizEmoji');
    if (accuracy === 1) {
        emojiEl.textContent = 'ğŸ˜'; // å…¨å•æ­£è§£
    } else if (accuracy >= 0.5) {
        emojiEl.textContent = 'ğŸ˜„'; // åŠåˆ†ä»¥ä¸Šæ­£è§£
    } else {
        emojiEl.textContent = 'ğŸ˜¢'; // åŠåˆ†ä»¥ä¸Šé–“é•ãˆãŸ
    }
    
    // çµ±è¨ˆã‚«ãƒ¼ãƒ‰ã‚’æ›´æ–°
    document.getElementById('quizCorrectCount').textContent = `${correct}/${total}`;
    document.getElementById('quizIncorrectCount').textContent = incorrect;

    const missList = document.getElementById('quizMistList');
    missList.innerHTML = '';
    if (quizState.mistakes.length > 0) {
        missList.innerHTML = `<h4 class="quiz-mistakes-heading">é–“é•ãˆãŸå•é¡Œã®è©³ç´°</h4>`;
        quizState.mistakes.forEach(m => {
            const item = document.createElement('div');
            item.className = 'quiz-miss-item';
            item.innerHTML = `<div class="miss-label">Q.</div><div class="miss-front">${m.front}</div><div class="miss-label">A.</div><div class="miss-back">${m.back}</div>`;
            missList.appendChild(item);
        });
    }

    const reviewReplayBtn = document.getElementById('reviewReplayBtn');
    if (quizState.mistakes.length === 0) {
        reviewReplayBtn.style.display = 'none';
        // é–“é•ã„ãŒ0ã®å ´åˆã¯ã‚«ãƒ¼ãƒ‰ã‚’ã‚¯ãƒªãƒƒã‚¯ä¸å¯ã«
        const incorrectCard = document.getElementById('incorrectCard');
        incorrectCard.style.cursor = 'default';
        incorrectCard.onclick = null;
        document.getElementById('mistakesArrow').style.display = 'none';
    } else {
        reviewReplayBtn.style.display = 'inline-block';
        reviewReplayBtn.disabled = false;
    }

    setSection('quizResult');
}

function toggleMistakesList() {
    const missList = document.getElementById('quizMistList');
    const arrow = document.getElementById('mistakesArrow');
    
    if (missList.style.display === 'none') {
        missList.style.display = 'block';
        arrow.textContent = 'â–²';
    } else {
        missList.style.display = 'none';
        arrow.textContent = 'â–¼';
    }
}

function restartPlay(mode) {
    const difficulty = difficultyParam || '15';
    if (mode === 'review') {
        window.location.href = `{% url 'wordbook_play' wordbook.pk %}?mode=review&difficulty=${difficulty}`;
    } else {
        window.location.href = `{% url 'wordbook_play' wordbook.pk %}?mode=all&difficulty=${difficulty}`;
    }
}

function startQuizTimer() {
    stopQuizTimer();
    const label = document.getElementById('quizTimerLabel');
    const circle = document.getElementById('quizTimerProgress');

    if (!quizState.timeLimit) {
        label.textContent = 'âˆ';
        if (circle) circle.style.strokeDashoffset = '0';
        return;
    }

    const duration = quizState.timeLimit;
    const start = Date.now();
    const circumference = 2 * Math.PI * 54;
    circle.style.strokeDasharray = circumference;

    quizState.timerId = setInterval(() => {
        const elapsed = (Date.now() - start) / 1000;
        const remaining = Math.max(0, duration - elapsed);
        label.textContent = Math.ceil(remaining);
        const progress = remaining / duration;
        circle.style.strokeDashoffset = circumference * (1 - progress);
        if (remaining <= 0.05) {
            stopQuizTimer();
            handleQuizAnswer(null, true);
        }
    }, 100);
}

function stopQuizTimer() {
    if (quizState.timerId) {
        clearInterval(quizState.timerId);
        quizState.timerId = null;
    }
}

function buildOptions(current) {
    const others = shuffleArray(quizCards.filter(c => c.id !== current.id));
    if (others.length < 3) {
        // ã‚«ãƒ¼ãƒ‰æ•°ãŒå°‘ãªã„å ´åˆã€é‡è¤‡ã‚’è¨±å¯ã—ã¦é¸æŠè‚¢ã‚’ç”Ÿæˆ
        const availableCards = [current, ...others];
        const options = [current];
        while (options.length < 4 && options.length <= availableCards.length) {
            const randomCard = availableCards[Math.floor(Math.random() * availableCards.length)];
            if (!options.find(opt => opt.id === randomCard.id)) {
                options.push(randomCard);
            }
        }
        return shuffleArray(options);
    }
    const options = [current, ...others.slice(0, 3)];
    return shuffleArray(options);
}

function shuffleArray(arr) {
    for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
}

function loadStoredMistakes() {
    try {
        const raw = localStorage.getItem(`quizMistakes_${quizWordbookId}`);
        return raw ? JSON.parse(raw) : [];
    } catch (e) {
        return [];
    }
}

function saveMistakes() {
    try {
        localStorage.setItem(`quizMistakes_${quizWordbookId}`, JSON.stringify(quizState.mistakes));
    } catch (e) {
        // localStorage unavailable; skip silently
    }
}

initQuiz();
</script>
{% endblock %}
