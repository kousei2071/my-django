{% extends 'home/base.html' %}

{% block title %}{{ wordbook.title }} - TANKORE{% endblock %}

{% block content %}
{% load static %}
<div class="wordbook-detail-container">
    <div class="container wordbook-detail-content">
        <div class="wordbook-detail-header">
            <a href="{% url 'wordbook_list' %}" class="btn-back-header" title="æˆ»ã‚‹">
                <i class="fas fa-arrow-left"></i>
            </a>
            {% if can_edit %}
            <div class="header-actions">
                <button onclick="openTagModal()" class="btn-header-action" title="ã‚¿ã‚°ã‚’ç·¨é›†">
                    <i class="fas fa-tags"></i>
                    <span>ã‚¿ã‚°</span>
                </button>
                <a href="{% url 'wordcard_create' wordbook.pk %}" class="btn-header-action" title="å˜èªã‚«ãƒ¼ãƒ‰ã‚’è¿½åŠ ">
                    <i class="fas fa-plus"></i>
                    <span>è¿½åŠ </span>
                </a>
            </div>
            {% endif %}
            <div class="wordbook-detail-left">
                <div class="wordbook-detail-image" style="background-color: {{ wordbook.get_background_color|default:'#fffff0' }};">
                    <img src="{{ wordbook.get_avatar_url }}" alt="{{ wordbook.user.username }}" style="width: 100%; height: 100%; object-fit: cover;">
                </div>
            </div>
            
            <div class="wordbook-detail-right">
                <h1 class="wordbook-detail-title">{{ wordbook.title }}</h1>
                
                <!-- ä½œæˆè€…æƒ…å ± -->
                {% if not wordbook.is_ai_generated %}
                <div class="creator-info">
                    <a href="{% url 'user_profile' wordbook.user.username %}" class="creator-link">
                        <img src="{{ wordbook.user.profile.get_avatar_url }}" alt="{{ wordbook.user.username }}" class="creator-avatar-small">
                        <span class="creator-username">{{ wordbook.user.username }}</span>
                    </a>
                </div>
                {% else %}
                <div class="creator-info">
                    <span class="ai-badge">
                        <i class="fas fa-robot"></i> AIç”Ÿæˆ
                    </span>
                </div>
                {% endif %}
                
                <!-- ã‚¿ã‚°è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
                <div class="tags-display">
                    {% if wordbook.tags.all %}
                        {% for tag in wordbook.tags.all %}
                            <a href="{% url 'wordbook_list' %}?tag={{ tag.name|urlencode }}" class="tag-chip tag-chip-link">
                                {{ tag.name }}
                            </a>
                        {% endfor %}
                    {% else %}
                        <span class="no-tags">ã‚¿ã‚°ãªã—</span>
                    {% endif %}
                </div>
                
                <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒãƒ¼ -->
                <div class="action-bar">
                    {% if cards.count >= 4 %}
                    <button class="action-btn btn-play" onclick="openQuizModal()" title="ãƒ—ãƒ¬ã‚¤">
                        <i class="fas fa-play"></i>
                        <span>ãƒ—ãƒ¬ã‚¤</span>
                    </button>
                    {% endif %}
                    
                    {% if user.is_authenticated %}
                    <button class="action-btn {% if user_has_liked %}active{% endif %}" onclick="toggleLike()" title="ã„ã„ã­">
                        <i class="fas fa-heart"></i>
                        <span id="likeCount">{{ likes_count }}</span>
                    </button>
                    
                    <button class="action-btn {% if user_has_bookmarked %}active{% endif %}" onclick="toggleBookmark()" title="ä¿å­˜">
                        <i class="fas fa-bookmark"></i>
                        <span id="bookmarkLabel">{% if user_has_bookmarked %}ä¿å­˜æ¸ˆã¿{% else %}ä¿å­˜{% endif %}</span>
                    </button>
                    
                    {% if can_edit %}
                    <label class="toggle-switch" title="å…¬é–‹è¨­å®š">
                        <input type="checkbox" id="publishToggle" {% if wordbook.is_public %}checked{% endif %} onchange="togglePublic()">
                        <span class="toggle-slider"></span>
                        <span class="toggle-label" id="publishLabel">{{ wordbook.is_public|yesno:"å…¬é–‹,éå…¬é–‹" }}</span>
                    </label>
                    {% else %}
                    <div class="action-btn" title="å…¬é–‹çŠ¶æ…‹">
                        <i class="fas fa-globe"></i>
                        <span class="action-label">å…¬é–‹ä¸­</span>
                    </div>
                    {% endif %}
                    {% else %}
                    <a href="{% url 'login' %}?next={{ request.get_full_path }}" class="action-btn" title="ã„ã„ã­">
                        <i class="far fa-heart"></i>
                        <span class="action-count">{{ likes_count }}</span>
                    </a>
                    <a href="{% url 'login' %}?next={{ request.get_full_path }}" class="action-btn" title="ä¿å­˜">
                        <i class="far fa-bookmark"></i>
                        <span class="action-label">ä¿å­˜</span>
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="wordcard-list">
            <h2>å˜èªã‚«ãƒ¼ãƒ‰ä¸€è¦§ ({{ cards.count }}æš)</h2>
            
            {% if cards %}
                <div class="wordcard-grid">
                {% for card in cards %}
                    <div class="wordcard">
                        <div class="wordcard-star-container">
                            <button class="btn-star {% if card.id in starred_card_ids %}is-starred{% endif %}" 
                                    onclick="toggleStar({{ card.id }}, this)" 
                                    title="æ˜Ÿã‚’ã¤ã‘ã‚‹">
                                {% if card.id in starred_card_ids %}
                                    <img src="{% static 'home/images/star.png' %}" alt="star" class="star-icon-img">
                                {% else %}
                                    <img src="{% static 'home/images/starblack.png' %}" alt="star" class="star-icon-img">
                                {% endif %}
                            </button>
                        </div>
                        <div class="wordcard-front">
                            <p class="word-text">{{ card.front_text }}</p>
                        </div>
                        <div class="wordcard-back">
                            <p class="meaning-text">{{ card.back_text }}</p>
                            {% if card.image %}
                                <img src="{{ card.image.url }}" alt="{{ card.front_text }}" class="card-image">
                            {% endif %}
                        </div>
                        {% if wordbook.user == user %}
                            <form method="post" action="{% url 'wordcard_delete' card.pk %}" class="delete-form">
                                {% csrf_token %}
                                <button type="submit" class="btn-delete" onclick="return confirm('ã“ã®å˜èªã‚«ãƒ¼ãƒ‰ã‚’å‰Šé™¤ã—ã¾ã™ã‹?')">å‰Šé™¤</button>
                            </form>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
        {% else %}
                <p class="empty-message">ã¾ã å˜èªã‚«ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å˜èªã‚«ãƒ¼ãƒ‰ã‚’è¿½åŠ ã—ã¾ã—ã‚‡ã†ï¼</p>
            {% endif %}
        </div>
    </div>
</div>

<!-- FAB (Floating Action Button) - ãƒ—ãƒ¬ã‚¤ãƒœã‚¿ãƒ³ã¯å‰Šé™¤ã€è¿½åŠ ãƒœã‚¿ãƒ³ã®ã¿ -->
{% if can_edit %}
<a href="{% url 'wordcard_create' wordbook.pk %}" class="fab fab-add" title="å˜èªã‚«ãƒ¼ãƒ‰ã‚’è¿½åŠ ">
    <i class="fas fa-plus"></i>
</a>
{% endif %}
<!-- ã‚¯ã‚¤ã‚ºé–‹å§‹ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆã‚¹ã‚¿ãƒ¼ãƒˆã®ã¿ï¼‰ -->
<div id="quizModal" class="quiz-modal" aria-hidden="true" style="display: none;">
    <div class="quiz-modal-overlay" role="dialog" aria-modal="true">
        <div class="quiz-modal-body">
            <button class="quiz-close" type="button" aria-label="é–‰ã˜ã‚‹" onclick="closeQuizModal()">&times;</button>

            <div id="quizSetup" class="quiz-section" style="display: block;">
                <h2>ã‚¯ã‚¤ã‚ºã‚’ãƒ—ãƒ¬ã‚¤</h2>
                <p class="quiz-sub">å˜èªå¸³ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«4æŠã§å‡ºé¡Œã—ã¾ã™ï¼ˆã‚«ãƒ¼ãƒ‰4æšä»¥ä¸ŠãŒå¿…è¦ã§ã™ï¼‰</p>

                <div class="quiz-setup-row">
                    <label for="quizDifficulty">é›£æ˜“åº¦ï¼ˆåˆ¶é™æ™‚é–“ï¼‰</label>
                    <select id="quizDifficulty" class="quiz-select">
                        <option value="15">ãµã¤ã†ï¼ˆ15ç§’ï¼‰</option>
                        <option value="5">ã‚€ãšã‹ã—ã„ï¼ˆ5ç§’ï¼‰</option>
                        <option value="unlimited">ç·´ç¿’ï¼ˆåˆ¶é™ãªã—ï¼‰</option>
                    </select>
                </div>

                <div class="quiz-setup-actions">
                    <button type="button" class="btn btn-primary" onclick="goPlayPage()">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ã‚¿ã‚°ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
{% if can_edit %}
<div id="tagModal" class="tag-modal">
    <div class="tag-modal-content">
        <div class="tag-modal-header">
            <h2>ã‚¿ã‚°ã‚’ç·¨é›†</h2>
            <button class="tag-modal-close" onclick="closeTagModal()">&times;</button>
        </div>
        <div class="tag-modal-body">
            <!-- ã‚¿ã‚°æ¤œç´¢ -->
            <div class="tag-search-section">
                <input type="text" id="tagSearchInput" placeholder="ã‚¿ã‚°ã‚’æ¤œç´¢..." oninput="searchTags()" style="width: 80%;">
            </div>
            
            <!-- é¸æŠä¸­ã®ã‚¿ã‚° -->
            <div class="selected-tags-section">
                <h3>é¸æŠä¸­ã®ã‚¿ã‚° (æœ€å¤§10å€‹)</h3>
                <div id="selectedTags" class="selected-tags-list"></div>
            </div>
            
            <!-- åˆ©ç”¨å¯èƒ½ãªã‚¿ã‚° -->
            <div class="available-tags-section">
                <h3>åˆ©ç”¨å¯èƒ½ãªã‚¿ã‚°</h3>
                <div id="availableTags" class="available-tags-list"></div>
            </div>
            
            <!-- æ–°ã—ã„ã‚¿ã‚°ã‚’ä½œæˆ -->
            <div class="create-tag-section">
                <h3>æ–°ã—ã„ã‚¿ã‚°ã‚’ä½œæˆ</h3>
                <div class="create-tag-form">
                    <input type="text" id="newTagInput" placeholder="ã‚¿ã‚°åã‚’å…¥åŠ›" maxlength="50">
                    <button class="btn btn-secondary" onclick="createTag()">ä½œæˆ</button>
                </div>
            </div>
        </div>
        <div class="tag-modal-footer">
            <button class="btn btn-secondary" onclick="closeTagModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            <button class="btn btn-primary" onclick="saveTags()">ä¿å­˜</button>
        </div>
    </div>
</div>

<script>
const wordbookId = {{ wordbook.pk }};
let allTags = [];
let selectedTagIds = [];

// åˆæœŸé¸æŠã‚¿ã‚°ã‚’è¨­å®š
document.addEventListener('DOMContentLoaded', function() {
    selectedTagIds = [{% for tag in wordbook.tags.all %}{{ tag.id }}{% if not forloop.last %},{% endif %}{% endfor %}];
});

function openTagModal() {
    document.getElementById('tagModal').style.display = 'flex';
    loadTags();
}

function closeTagModal() {
    document.getElementById('tagModal').style.display = 'none';
}

function loadTags(query = '') {
    const url = query ? `/tags/?q=${encodeURIComponent(query)}&limit=50` : '/tags/?limit=50';
    fetch(url)
        .then(res => res.json())
        .then(data => {
            allTags = data.tags;
            renderTags();
        })
        .catch(err => console.error('ã‚¿ã‚°èª­è¾¼ã‚¨ãƒ©ãƒ¼:', err));
}

function searchTags() {
    const query = document.getElementById('tagSearchInput').value;
    loadTags(query);
}

function renderTags() {
    // é¸æŠä¸­ã®ã‚¿ã‚°ã‚’è¡¨ç¤º
    const selectedContainer = document.getElementById('selectedTags');
    const selectedTags = allTags.filter(t => selectedTagIds.includes(t.id));
    if (selectedTags.length === 0) {
        selectedContainer.innerHTML = '<p class="empty-tags">ã‚¿ã‚°ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“</p>';
    } else {
        selectedContainer.innerHTML = selectedTags.map(tag => 
            `<span class="tag-chip selected" onclick="removeTag(${tag.id})">
                ${tag.name} <span class="remove-icon">Ã—</span>
            </span>`
        ).join('');
    }
    
    // åˆ©ç”¨å¯èƒ½ãªã‚¿ã‚°ã‚’è¡¨ç¤º
    const availableContainer = document.getElementById('availableTags');
    const availableTags = allTags.filter(t => !selectedTagIds.includes(t.id));
    if (availableTags.length === 0) {
        availableContainer.innerHTML = '<p class="empty-tags">åˆ©ç”¨å¯èƒ½ãªã‚¿ã‚°ãŒã‚ã‚Šã¾ã›ã‚“</p>';
    } else {
        availableContainer.innerHTML = availableTags.map(tag => {
            const deleteBtn = tag.created_by_me ? 
                `<button class="btn-delete-tag" onclick="deleteTag(${tag.id}, event)" title="å‰Šé™¤">ğŸ—‘ï¸</button>` : '';
            return `<span class="tag-chip available" onclick="addTag(${tag.id})">
                ${tag.name} <span class="add-icon">+</span>
                ${deleteBtn}
            </span>`;
        }).join('');
    }
}

function addTag(tagId) {
    if (selectedTagIds.length >= 10) {
        alert('ã‚¿ã‚°ã¯æœ€å¤§10å€‹ã¾ã§é¸æŠã§ãã¾ã™');
        return;
    }
    if (!selectedTagIds.includes(tagId)) {
        selectedTagIds.push(tagId);
        renderTags();
    }
}

function removeTag(tagId) {
    selectedTagIds = selectedTagIds.filter(id => id !== tagId);
    renderTags();
}

function createTag() {
    const input = document.getElementById('newTagInput');
    const name = input.value.trim();
    if (!name) {
        alert('ã‚¿ã‚°åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
    }
    
    const formData = new FormData();
    formData.append('name', name);
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
    
    fetch('/tags/create/', {
        method: 'POST',
        body: formData
    })
    .then(res => res.json())
    .then(data => {
        if (data.id) {
            input.value = '';
            loadTags();
            if (!selectedTagIds.includes(data.id)) {
                addTag(data.id);
            }
        } else if (data.error) {
            alert('ã‚¨ãƒ©ãƒ¼: ' + data.error.message);
        }
    })
    .catch(err => {
        console.error('ã‚¿ã‚°ä½œæˆã‚¨ãƒ©ãƒ¼:', err);
        alert('ã‚¿ã‚°ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
    });
}

function saveTags() {
    const formData = new FormData();
    formData.append('tag_ids', selectedTagIds.join(','));
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
    
    console.log('Saving tags:', selectedTagIds);
    console.log('Wordbook ID:', wordbookId);
    
    fetch(`/wordbooks/${wordbookId}/tags/`, {
        method: 'POST',
        body: formData
    })
    .then(res => {
        console.log('Response status:', res.status);
        return res.json();
    })
    .then(data => {
        console.log('Response data:', data);
        if (data.ok) {
            location.reload();
        } else if (data.error) {
            alert('ã‚¨ãƒ©ãƒ¼: ' + data.error.message);
        }
    })
    .catch(err => {
        console.error('ã‚¿ã‚°ä¿å­˜ã‚¨ãƒ©ãƒ¼:', err);
        alert('ã‚¿ã‚°ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
    });
}

function deleteTag(tagId, event) {
    event.stopPropagation();
    
    const tag = allTags.find(t => t.id === tagId);
    if (!tag) return;
    
    if (!confirm(`ã€Œ${tag.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nâ€»ä½¿ç”¨ä¸­ã®å ´åˆã¯å‰Šé™¤ã§ãã¾ã›ã‚“`)) {
        return;
    }
    
    const formData = new FormData();
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
    
    fetch(`/tags/${tagId}/delete/`, {
        method: 'POST',
        body: formData
    })
    .then(res => res.json())
    .then(data => {
        if (data.ok) {
            loadTags();
        } else if (data.error) {
            alert('ã‚¨ãƒ©ãƒ¼: ' + data.error.message);
        }
    })
    .catch(err => {
        console.error('ã‚¿ã‚°å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', err);
        alert('ã‚¿ã‚°ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
    });
}
</script>
{% endif %}

<script>
function toggleStar(cardId, btn) {
    {% if not user.is_authenticated %}
        window.location.href = "{% url 'login' %}?next={{ request.get_full_path }}";
        return;
    {% endif %}

    fetch(`/wordcards/${cardId}/star/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
        }
    })
    .then(res => res.json())
    .then(data => {
        const img = btn.querySelector('.star-icon-img');
        if (data.is_starred) {
            btn.classList.add('is-starred');
            img.src = "{% static 'home/images/star.png' %}";
        } else {
            btn.classList.remove('is-starred');
            img.src = "{% static 'home/images/starblack.png' %}";
        }
    })
    .catch(err => console.error('Star toggle error:', err));
}

// ãƒ¢ãƒ¼ãƒ€ãƒ«ã®å¤–å´ã‚’ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
window.onclick = function(event) {
    const modal = document.getElementById('tagModal');
    if (modal && event.target === modal) {
        closeTagModal();
    }
}
</script>

<script>
const quizWordbookId = {{ wordbook.pk }};
const quizCardCount = {{ cards.count }};
const csrftoken = '{{ csrf_token }}';

function toggleLike() {
    const btn = event.currentTarget;
    fetch('{% url "wordbook_like" wordbook.pk %}', {
        method: 'POST',
        headers: {'X-CSRFToken': csrftoken}
    }).then(r => r.json()).then(d => {
        btn.classList.toggle('active');
        document.getElementById('likeCount').textContent = d.likes_count;
    });
}

function toggleBookmark() {
    const btn = event.currentTarget;
    fetch('{% url "wordbook_bookmark" wordbook.pk %}', {
        method: 'POST',
        headers: {'X-CSRFToken': csrftoken}
    }).then(r => r.json()).then(d => {
        btn.classList.toggle('active');
        document.getElementById('bookmarkLabel').textContent = d.bookmarked ? 'ä¿å­˜æ¸ˆã¿' : 'ä¿å­˜';
    });
}

function togglePublic() {
    const toggle = document.getElementById('publishToggle');
    fetch('{% url "wordbook_toggle_public" wordbook.pk %}', {
        method: 'POST',
        headers: {'X-CSRFToken': csrftoken}
    }).then(r => r.json()).then(d => {
        document.getElementById('publishLabel').textContent = d.is_public ? 'å…¬é–‹' : 'éå…¬é–‹';
    });
}

function openQuizModal() {
    if (quizCardCount < 4) {
        alert('ãƒ—ãƒ¬ã‚¤ã™ã‚‹ã«ã¯ã‚«ãƒ¼ãƒ‰ãŒ4æšä»¥ä¸Šå¿…è¦ã§ã™');
        return;
    }
    document.getElementById('quizModal').style.display = 'block';
}

function closeQuizModal() {
    document.getElementById('quizModal').style.display = 'none';
}

function goPlayPage() {
    const difficulty = document.getElementById('quizDifficulty').value;
    window.location.href = `/wordbooks/${quizWordbookId}/play/?mode=all&difficulty=${difficulty}`;
}

function startQuiz(quizType) {
    window.location.href = `/wordbooks/${quizWordbookId}/play/?type=${quizType}`;
}
</script>

{% endblock %}
