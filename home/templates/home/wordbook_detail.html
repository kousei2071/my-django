{% extends 'home/base.html' %}

{% block title %}{{ wordbook.title }} - TANKORE{% endblock %}

{% block content %}
{% load static %}
<div class="container">
    <div class="wordbook-detail-header">
        <div class="wordbook-detail-left">
            <div class="wordbook-detail-image" style="background-color: {{ wordbook.user.profile.background_color|default:'#fffff0' }};">
                <img src="{% static 'home/images/django icon/' %}{{ wordbook.user.profile.avatar_image|default:'account.png' }}" alt="{{ wordbook.user.username }}" style="width: 100%; height: 100%; object-fit: cover;">
            </div>
        </div>
        
                <div class="wordbook-detail-right">
                        <h1 class="wordbook-detail-title">{{ wordbook.title }}</h1>
            
            <!-- ã‚¿ã‚°è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
            <div class="tags-display">
                {% if wordbook.tags.all %}
                    {% for tag in wordbook.tags.all %}
                        <a href="{% url 'wordbook_list' %}?tag={{ tag.name|urlencode }}" class="tag-chip tag-chip-link">
                            {{ tag.name }}
                        </a>
                    {% endfor %}
                {% else %}
                    <span class="no-tags">ã‚¿ã‚°ãªã—</span>
                {% endif %}
                {% if can_edit %}
                    <button class="btn-edit-tags" onclick="openTagModal()">ã‚¿ã‚°ã‚’ç·¨é›†</button>
                {% endif %}
            </div>
            
            <div class="like-action action-buttons">
            {% if user.is_authenticated %}
                <form method="post" action="{% url 'wordbook_like' wordbook.pk %}">
                    {% csrf_token %}
                     <input type="hidden" name="next" value="{{ request.get_full_path }}">
                     <button type="submit" class="btn btn-secondary {% if user_has_liked %}is-liked{% endif %}">
                      <img src="{% static 'home/images/like-3d.png' %}" alt="ã„ã„ã­" class="like-icon"> {{ likes_count }} {% if user_has_liked %}å–ã‚Šæ¶ˆã™{% else %}ã„ã„ã­{% endif %}
                    </button>
                 </form>
                 <form method="post" action="{% url 'wordbook_bookmark' wordbook.pk %}">
                    {% csrf_token %}
                    <input type="hidden" name="next" value="{{ request.get_full_path }}">
                    <button type="submit" class="btn btn-secondary {% if user_has_bookmarked %}is-bookmarked{% endif %}">
                        <img src="{% static 'home/images/bookmark_3d.png' %}" alt="ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯" class="bookmark-icon"> {% if user_has_bookmarked %}ä¿å­˜æ¸ˆã¿{% else %}ä¿å­˜ã™ã‚‹{% endif %}
                    </button>
                 </form>
              {% else %}
                 <a class="btn btn-secondary" href="{% url 'login' %}?next={{ request.get_full_path }}">ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã„ã­ãƒ»ä¿å­˜</a>
            {% endif %}
        </div>
                    {% if can_edit %}
                <a href="{% url 'wordcard_create' wordbook.pk %}" class="btn btn-primary">+ å˜èªã‚«ãƒ¼ãƒ‰ã‚’è¿½åŠ </a>
                <a href="{% url 'wordbook_list' %}" class="btn btn-secondary">å˜èªå¸³ä¸€è¦§ã«æˆ»ã‚‹</a>
            {% endif %}
        </div>
    </div>

    <div class="wordcard-list">
        <h2>å˜èªã‚«ãƒ¼ãƒ‰ä¸€è¦§ ({{ cards.count }}æš)</h2>
        
        {% if cards %}
            <div class="wordcard-grid">
                {% for card in cards %}
                    <div class="wordcard">
                        <div class="wordcard-front">
                            <p class="word-text">{{ card.front_text }}</p>
                        </div>
                        <div class="wordcard-back">
                            <p class="meaning-text">{{ card.back_text }}</p>
                            {% if card.image %}
                                <img src="{{ card.image.url }}" alt="{{ card.front_text }}" class="card-image">
                            {% endif %}
                        </div>
                        {% if wordbook.user == user %}
                            <form method="post" action="{% url 'wordcard_delete' card.pk %}" class="delete-form">
                                {% csrf_token %}
                                <button type="submit" class="btn-delete" onclick="return confirm('ã“ã®å˜èªã‚«ãƒ¼ãƒ‰ã‚’å‰Šé™¤ã—ã¾ã™ã‹?')">å‰Šé™¤</button>
                            </form>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <p class="empty-message">ã¾ã å˜èªã‚«ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å˜èªã‚«ãƒ¼ãƒ‰ã‚’è¿½åŠ ã—ã¾ã—ã‚‡ã†ï¼</p>
        {% endif %}
    </div>
</div>

<!-- ã‚¿ã‚°ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
{% if can_edit %}
<div id="tagModal" class="tag-modal">
    <div class="tag-modal-content">
        <div class="tag-modal-header">
            <h2>ã‚¿ã‚°ã‚’ç·¨é›†</h2>
            <button class="tag-modal-close" onclick="closeTagModal()">&times;</button>
        </div>
        <div class="tag-modal-body">
            <!-- ã‚¿ã‚°æ¤œç´¢ -->
            <div class="tag-search-section">
                <input type="text" id="tagSearchInput" placeholder="ã‚¿ã‚°ã‚’æ¤œç´¢..." oninput="searchTags()" style="width: 80%;">
            </div>
            
            <!-- é¸æŠä¸­ã®ã‚¿ã‚° -->
            <div class="selected-tags-section">
                <h3>é¸æŠä¸­ã®ã‚¿ã‚° (æœ€å¤§10å€‹)</h3>
                <div id="selectedTags" class="selected-tags-list"></div>
            </div>
            
            <!-- åˆ©ç”¨å¯èƒ½ãªã‚¿ã‚° -->
            <div class="available-tags-section">
                <h3>åˆ©ç”¨å¯èƒ½ãªã‚¿ã‚°</h3>
                <div id="availableTags" class="available-tags-list"></div>
            </div>
            
            <!-- æ–°ã—ã„ã‚¿ã‚°ã‚’ä½œæˆ -->
            <div class="create-tag-section">
                <h3>æ–°ã—ã„ã‚¿ã‚°ã‚’ä½œæˆ</h3>
                <div class="create-tag-form">
                    <input type="text" id="newTagInput" placeholder="ã‚¿ã‚°åã‚’å…¥åŠ›" maxlength="50">
                    <button class="btn btn-secondary" onclick="createTag()">ä½œæˆ</button>
                </div>
            </div>
        </div>
        <div class="tag-modal-footer">
            <button class="btn btn-secondary" onclick="closeTagModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            <button class="btn btn-primary" onclick="saveTags()">ä¿å­˜</button>
        </div>
    </div>
</div>

<script>
const wordbookId = {{ wordbook.pk }};
let allTags = [];
let selectedTagIds = [];

// åˆæœŸé¸æŠã‚¿ã‚°ã‚’è¨­å®š
document.addEventListener('DOMContentLoaded', function() {
    selectedTagIds = [{% for tag in wordbook.tags.all %}{{ tag.id }}{% if not forloop.last %},{% endif %}{% endfor %}];
});

function openTagModal() {
    document.getElementById('tagModal').style.display = 'flex';
    loadTags();
}

function closeTagModal() {
    document.getElementById('tagModal').style.display = 'none';
}

function loadTags(query = '') {
    const url = query ? `/tags/?q=${encodeURIComponent(query)}&limit=50` : '/tags/?limit=50';
    fetch(url)
        .then(res => res.json())
        .then(data => {
            allTags = data.tags;
            renderTags();
        })
        .catch(err => console.error('ã‚¿ã‚°èª­è¾¼ã‚¨ãƒ©ãƒ¼:', err));
}

function searchTags() {
    const query = document.getElementById('tagSearchInput').value;
    loadTags(query);
}

function renderTags() {
    // é¸æŠä¸­ã®ã‚¿ã‚°ã‚’è¡¨ç¤º
    const selectedContainer = document.getElementById('selectedTags');
    const selectedTags = allTags.filter(t => selectedTagIds.includes(t.id));
    if (selectedTags.length === 0) {
        selectedContainer.innerHTML = '<p class="empty-tags">ã‚¿ã‚°ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“</p>';
    } else {
        selectedContainer.innerHTML = selectedTags.map(tag => 
            `<span class="tag-chip selected" onclick="removeTag(${tag.id})">
                ${tag.name} <span class="remove-icon">Ã—</span>
            </span>`
        ).join('');
    }
    
    // åˆ©ç”¨å¯èƒ½ãªã‚¿ã‚°ã‚’è¡¨ç¤º
    const availableContainer = document.getElementById('availableTags');
    const availableTags = allTags.filter(t => !selectedTagIds.includes(t.id));
    if (availableTags.length === 0) {
        availableContainer.innerHTML = '<p class="empty-tags">åˆ©ç”¨å¯èƒ½ãªã‚¿ã‚°ãŒã‚ã‚Šã¾ã›ã‚“</p>';
    } else {
        availableContainer.innerHTML = availableTags.map(tag => {
            const deleteBtn = tag.created_by_me ? 
                `<button class="btn-delete-tag" onclick="deleteTag(${tag.id}, event)" title="å‰Šé™¤">ğŸ—‘ï¸</button>` : '';
            return `<span class="tag-chip available" onclick="addTag(${tag.id})">
                ${tag.name} <span class="add-icon">+</span>
                ${deleteBtn}
            </span>`;
        }).join('');
    }
}

function addTag(tagId) {
    if (selectedTagIds.length >= 10) {
        alert('ã‚¿ã‚°ã¯æœ€å¤§10å€‹ã¾ã§é¸æŠã§ãã¾ã™');
        return;
    }
    if (!selectedTagIds.includes(tagId)) {
        selectedTagIds.push(tagId);
        renderTags();
    }
}

function removeTag(tagId) {
    selectedTagIds = selectedTagIds.filter(id => id !== tagId);
    renderTags();
}

function createTag() {
    const input = document.getElementById('newTagInput');
    const name = input.value.trim();
    if (!name) {
        alert('ã‚¿ã‚°åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
    }
    
    const formData = new FormData();
    formData.append('name', name);
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
    
    fetch('/tags/create/', {
        method: 'POST',
        body: formData
    })
    .then(res => res.json())
    .then(data => {
        if (data.id) {
            input.value = '';
            loadTags();
            if (!selectedTagIds.includes(data.id)) {
                addTag(data.id);
            }
            if (data.created) {
                alert('æ–°ã—ã„ã‚¿ã‚°ã‚’ä½œæˆã—ã¾ã—ãŸ: ' + data.name);
            } else {
                alert('æ—¢å­˜ã®ã‚¿ã‚°ã‚’è¿½åŠ ã—ã¾ã—ãŸ: ' + data.name);
            }
        } else if (data.error) {
            alert('ã‚¨ãƒ©ãƒ¼: ' + data.error.message);
        }
    })
    .catch(err => {
        console.error('ã‚¿ã‚°ä½œæˆã‚¨ãƒ©ãƒ¼:', err);
        alert('ã‚¿ã‚°ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
    });
}

function saveTags() {
    const formData = new FormData();
    formData.append('tag_ids', selectedTagIds.join(','));
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
    
    console.log('Saving tags:', selectedTagIds);
    console.log('Wordbook ID:', wordbookId);
    
    fetch(`/wordbooks/${wordbookId}/tags/`, {
        method: 'POST',
        body: formData
    })
    .then(res => {
        console.log('Response status:', res.status);
        return res.json();
    })
    .then(data => {
        console.log('Response data:', data);
        if (data.ok) {
            alert('ã‚¿ã‚°ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
            location.reload();
        } else if (data.error) {
            alert('ã‚¨ãƒ©ãƒ¼: ' + data.error.message);
        }
    })
    .catch(err => {
        console.error('ã‚¿ã‚°ä¿å­˜ã‚¨ãƒ©ãƒ¼:', err);
        alert('ã‚¿ã‚°ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
    });
}

function deleteTag(tagId, event) {
    event.stopPropagation();
    
    const tag = allTags.find(t => t.id === tagId);
    if (!tag) return;
    
    if (!confirm(`ã€Œ${tag.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nâ€»ä½¿ç”¨ä¸­ã®å ´åˆã¯å‰Šé™¤ã§ãã¾ã›ã‚“`)) {
        return;
    }
    
    const formData = new FormData();
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
    
    fetch(`/tags/${tagId}/delete/`, {
        method: 'POST',
        body: formData
    })
    .then(res => res.json())
    .then(data => {
        if (data.ok) {
            alert('ã‚¿ã‚°ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
            loadTags();
        } else if (data.error) {
            alert('ã‚¨ãƒ©ãƒ¼: ' + data.error.message);
        }
    })
    .catch(err => {
        console.error('ã‚¿ã‚°å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', err);
        alert('ã‚¿ã‚°ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
    });
}

// ãƒ¢ãƒ¼ãƒ€ãƒ«ã®å¤–å´ã‚’ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
window.onclick = function(event) {
    const modal = document.getElementById('tagModal');
    if (event.target === modal) {
        closeTagModal();
    }
}
</script>
{% endif %}

{% endblock %}
